Smart-Todo 待办管理器
========================

![](https://img.shields.io/github/license/LiZeC123/SmartTodo)
![](https://img.shields.io/github/issues/LiZeC123/SmartTodo)
![](https://img.shields.io/github/v/tag/LiZeC123/SmartTodo)

Smart-Todo是一个简单智能的待办事项管理程序. Smart-Todo提供了创建和删除待办事项的基础功能, 并在此基础上自动优先级排序, 离线下载文件, 创建便签等重要的辅助功能.

![SmartTodo项目截图](doc/image/SmartTodo项目截图.PNG)


项目部署
-------------

本项目已经支持Docker方式部署, clone本项目后, 执行如下命令构建镜像并运行

```bash
docker-compose build && docker-compose up -d
```

项目默认在8080端口提供服务. 



基本配置
-------------

本项目在config文件夹中提供了一个默认配置文件(`config/default.json`), 在本地运行或者测试时可以直接使用默认配置.

默认提供了两个测试用户, 信息如下

用户名       | 密码           | 权限
------------|---------------|---------------------------
`admin`     | `123456`      | `ROLE_ADMIN`, `ROLE_USER`
`user`      | `123456`      | `ROLE_USER`  

其中`user`用户仅拥有普通权限, 仅能够普通的使用系统的基本功能,
而`admin`用户具有管理员权限, 除了普通的使用系统外, 还可以查看系统日志, 执行特殊指令.

如果将项目部署在公网, 建议在config文件夹中创建`config.json`文件来覆盖原有配置. 
当`config.json`与`default.json`同时存在时, 优先加载`config.json`.




基础特性介绍
-------------

### 截止日期

在创建任意类型的任务时, 可以使用`-dl`参数来设置截止日期. 例如

```
写日记 -dl 11.12
周末会议 -dl 3.12:12
```
可以用`11.12`的方式指定日期为11月12日, 也可以使用`3.12:12`的方式将截止日期精确到3月12日中午12点.

如果不指定小时, 则默认为当天的零点, 不需要指定年份, 程序会自动推断未来一年内最接近的日期.

### 特定日期任务

在创建任意类型的任务时, 可以使用`-sp`参数来设置每周的触发时间. 例如

```
周日任务 -sp 7
```

则每周日此任务会自动转换为待办状态. `-sp`后的数字表示一周的第几天, 从周一开始, 且用数字1表示周一.


### 可重复标记

在创建任意类型的任务时, 可以使用`-re`参数来标记为可重复任务. 例如

```
每日看论文 -re
```

标记为可重复任务的项目在标记为完成状态后不会被垃圾收集, 并且在第二天自动变为未完成状态 


### 工作段任务标记

在创建任意类型的任务时, 可以使用`-wk`参数来标记为工作段任务. 例如

```
工作时间的任务 -wk
```

工作段任务在工作时间段会提高展示的优先级, 在非工作时间段会降低展示的优先级.

> 工作时间段的定义为 周一到周五 上午9点到下午6点

### 网页书签

在创建待办时, 如果输入一个URL, 则自动将此URL对应的页面的标题作为此待办的标题.
创建完成后, 直接点击这个待办可打开相应的网页.

### 新生代与老年代

系统中的项目可以划分为新生代和老年代. 新生代中的待办事项快速的创建和消亡, 老年代中的任务会保持一段较长的时间.


自动优先级
--------------

如果给定了必要的属性, 程序将自动对任务进行优先级排序.

### 基础概念

1. 两个不具有任何特殊属性的Item之间, 根据创建时间决定优先级, 创建时间越晚, 优先级越高.
2. 所有的优先级算法都通过间接影响创建时间实现优先级的变化. 
3. 一个Item的优先级提高 1 天, 相当于比同时间提交的普通任务晚 1 天提交.

自动优先级算法通过将Item的创建时间以及各种特殊属性影响的时间都转换为浮点数后相加得到总分值, 然后对总分值进行排序实现自动优先级.


### 工作时间段

具有工作时间段属性的任务将会根据当前是否为工作时间段调整优先级, 规则如下

1. 如果现在处于工作时间段, 任务优先级提高 30 天
2. 如果现在不处于工作时间段, 任务优先级降级 30 天

> 工作时间段的定义为 周一到周五 上午9点到下午6点


### 截止日期

创建任务时, 可以设置截止日期. 系统将根据截止日期的远近进行排序. 规则如下

如果现在距离截止日期还有X天, 则任务优先级提高 (56 - 8X) 天

--------

根据截止日期与当前时间, 可以计算出urgent等级, 并依据等级在页面上使用不同的颜色预警. 规则如下

颜色  | 截止日期
------|------------------------
红色  | 距离截止日期小于1天
橙色  | 距离截止日期小于2天
黄色  | 距离截止日期小于3天
蓝色  | 距离截止日期小于4天

-----------

此算法应该满足如下的约束条件

1. X>7时, 优先级降低
2. X=7时, 优先级不提高也不降低
3. X>3时, 优先级一定程度提高
4. X=3时, 优先级至少提高 30 天, 从而比工作任务优先展示
5. 函数应该尽可能平滑, 不存在间断点

> 使用线性插值是满足上述条件的最简单方案

### 特定任务 

特定任务在每周的特定的一天触发, 属于最高优先级的任务. 特定任务触发时, 会在当前时间的基础上将优先级提高 100 天


文件控制
------------

文件是一种特殊类型的Item, 点击文件类型的Item后, 会自动从服务器下载此文件.

### 离线下载文件

创建Item时选择下载文件类型, 输入需要下载的文件URL, 服务器将下载指定的文件, 并创建一个文件标记的Item.

> 如果没有选择下载文件类型, 则输入的URL会当做书签处理, 获取对应URL的标题
> 如果URL以特定文件扩展名结尾, 则会询问是否需要按照下载文件类型处理

### 本地上传文件

点击上传文件, 选择需要上传的文件, 文件将会上传到服务器, 并且生成一个文件标记的Item.

> 通过上传和下载可以实现文件中转功能

### 文件生命周期

- 无论是上传的文件还是下载的文件, 都与Item的生命周期绑定
- 当Item被删除时, 相应的文件同时被删除


Note系统
--------------

Note是一种特殊的Item, 创建完成后, 点击相应的Item会跳转到一个Note页面. 其中包含一个可以编辑的窗口, 可以通过此窗口输入任意的文本内容.

Note页面内可以继续创建Item, 此页面内创建的Item只在此页面可见. 借助于此功能, 可以将一个计划放入一个Note, 并逐步分解为Item.

当Note对应的Item被删除时, Note所包含的全部数据同时被删除(通过类似Java的引用分析来回收资源).

> 创建Item时, 如果名称中包含`计划`, `规划`等词汇, 也会询问用户是否要创建Note类型的Item

### 自动保存

在Note页面, 输入的内容会静默的执行自动保存, 每分钟保存一次. 也可以使用Ctrl+S手动保存.

### 实现参考

- [10行 JavaScript 实现文本编辑器](https://segmentfault.com/a/1190000008454793)

类型与属性
---------------------

**以下是本项目的一些开发细节, 非开发者可以不用关注.**

虽然都表现为一个待办项目, 但系统实际上可以按照类型和属性进行划分. 整个系统有三个类型, 即

类型    | 含义
--------|--------------------------------
single  | 普通的待办项目
file    | 离线下载或者上传的文件
note    | 创建的便签

与此同时, 还有一个平行的属性系统, 系统中具有如下的一些属性

属性        | 含义
------------|--------------------------------
deadline    | 截止时间
sp/re/work  | 是否为 特殊/可重复/工作 任务
old         | 是否为老年代项目
url         | 项目对应的连接

任意一个项目只能具有一个类型, 但可以拥有任意数量的属性.


指令系统
-----------------

**注意: 指令系统目前处于重构状态, 暂时不可用**

### 设置属性

对于大部分操作而言, 本质上是重新设置某个属性, 因此设置属性的指令的格式为

```
set <name1>, <name2>, <name3> -> <attr1>, <attr2> = <value1>, <value2>
```

- `<name>`是Item的任意一部分文字片段, 要求选择的文字片段具有唯一性.
- `<attr>`是属性名称, 支持简写. 对应关系参考`service4interpreter.py/attr_name_map`
- `<value>`是设置的属性, 支持None/True/False等字面量以及日期
- `<value>`部分支持以文字片段的方式代替id, 此时需要将文本放在`< >`之中

例如
```
读书笔记->p = <读书计划>
```
将会把包含文字`读书笔记`的Item的parent属性的值设置为包含文字`读书计划`的id
通过这样的指令, 可以将一个全局创建的Item移动到一个Note中


### 执行函数

对于少部分操作, 需要分为多个步骤来设置属性, 为了简化这部分操作, 本项目提供了一些内置的函数来直接完成相关的操作. 

通过调用这些函数, 能够简单的完成一些需要多步骤的复杂操作

指令格式为

```
func <function_name> <arg>
```

函数                      | 含义
-------------------------|------------------------------------------------
`func public <name>`     | 将包含`<name>`指定的字符串的Item文件移动到公共空间
`func private <name>`    | 将包含`<name>`指定的字符串的Item文件移动到用户的私有空间



开发说明
---------------

### 调试时间模式

在项目中创建一个名为`database/time.debug`的文件, 并写入一个标准的时间格式字符串, 例如

```
2020-6-26 18:58:29
```

在程序启动时, 如果检测到此文件存在, 则所有关于时间的API都会返回此文件制定的时间. 
此操作支持动态加载, 因此在需要调试时间相关的问题时, 可以利用此机制实现时间的任意切换.

### 线程竞争问题

由于有GIL的存在, CPython实现下, 部分Python操作天然就是原子的. 
例如list的append操作, 天然具有原子性, 但是对于list的remove操作, 则不具有原子性. 

由于本项目采用list结构存储用户数据, 而用户数据存在同时插入和删除的可能性, 因此如果不加锁, 还是有可能导致数据结构出现错误.

考虑到本项目大部分时候的操作时查询, 因此仅需要在插入和删除的地方加入一个普通的锁, 使插入和删除在任意时刻均只能有一个操作执行即可保证数据的安全性.

- [列表与队列——谈谈线程安全](https://juejin.cn/post/6844903615824396295)

### 版本号

基于一般的版本号约定, 大版本号不同的程序可能存在不兼容的情况. 请注意程序的版本号, 不同版本号的程序可能对数据模型进行变更, 导致以往的数据无效.



开源项目和组件
----------------

感谢以下的开源项目和免费组件:

- [网站ico图标来源](https://www.iconfont.cn/search/index?q=todolist&page=1&fromCollection=1)
- [svg转ico工具](https://www.aconvert.com/cn/icon/svg-to-ico/)


参考资料
--------------

### Python
- [How to upgrade to python 3.7 on Ubuntu 18.10](https://www.itsupportwale.com/blog/how-to-upgrade-to-python-3-7-on-ubuntu-18-10/)
- [Python datetime 处理时区信息](https://yanbin.blog/python-datetime-timezone/)

### Vue.js
- [Vue.js——60分钟快速入门](https://www.cnblogs.com/keepfool/p/5619070.html)
- [使用 axios 访问 API](https://cn.vuejs.org/v2/cookbook/using-axios-to-consume-apis.html)
